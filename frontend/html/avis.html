<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Avis | EFREI & DECOUVERTE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700;500&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header id="navbar">
        <div class="nav">
            <div class="logo">EFREI & DECOUVERTE</div>
            <nav>
                <a href="../index.html">ACCUEIL</a>
                <a href="destinations.html">DESTINATIONS</a>
                <a href="avis.html" class="active">AVIS</a>
                <a href="forum.html">FORUM</a>
                <span id="user-menu-container">
                    <a href="login.html" id="user-menu-link" class="user-nav">SE CONNECTER</a>
                    <div id="user-dropdown" class="dropdown-menu" style="display: none;"></div>
                </span>
            </nav>
        </div>
    </header>
    <main>
        <h2>Avis des étudiants</h2>
        <ul class="avis-list" id="avis-list">
            <li>Chargement des avis...</li>
        </ul>
    </main>
    <footer>
        <p>© 2024 EFREI & DECOUVERTE. LEE Zhuo Chan Stive & TEILLET Paul & SHANG Jacky & GERMANY Nathan.</p>
    </footer>
    <script src="../js/connexion.js"></script>
    <!-- Script actions like/signalement : à placer dans un fichier commun réutilisable -->
    <script src="../js/avis_actions.js"></script>
    <script src="../js/config.js"></script>
    <script>
        async function afficherTousLesAvis() {
            try {
                const res = await fetch(window.API_BASE_URL + '/api/avis');
                const avisList = await res.json();
                const ul = document.getElementById('avis-list');
                if (!avisList.length) {
                    ul.innerHTML = "<li>Aucun avis disponible.</li>";
                    return;
                }
                ul.innerHTML = "";

                const id_utilisateur = localStorage.getItem('id_utilisateur');
                // On récupère statut "liked" et nombre de likes pour chaque avis
                const finalList = await Promise.all(avisList.map(async avis => {
                    let liked = false;
                    if (id_utilisateur) {
                        try {
                            const resLike = await fetch(`${window.API_BASE_URL}/api/avis/${avis.id_avis}/like/${id_utilisateur}`);
                            const dataLike = await resLike.json();
                            liked = dataLike.liked;
                        } catch (e) {
                            liked = false;
                        }
                    }
                    let nbLikes = 0;
                    try {
                        const resNb = await fetch(`${window.API_BASE_URL}/api/avis/${avis.id_avis}/likes`);
                        const dataNb = await resNb.json();
                        nbLikes = dataNb.likes;
                    } catch (e) {
                        nbLikes = avis.likes || 0;
                    }
                    return { avis, liked, nbLikes };
                }));

                finalList.forEach(item => {
                    const avis = item.avis;
                    const liked = item.liked;
                    const nbLikes = item.nbLikes;
                    ul.innerHTML += `
                        <li class="avis-item">
                            <div class="avis-header">
                                <span class="avis-auteur">${avis.prenom} ${avis.nom}</span>
                                <span class="avis-date">${avis.date_creation ? new Date(avis.date_creation).toLocaleDateString('fr-FR') : avis.annee_mobilite || ''}</span>
                            </div>
                            <div class="avis-destination"><b>${avis.universite}</b>, ${avis.ville}, ${avis.pays}</div>
                            <div class="avis-type">${avis.code_type} — ${avis.annee_mobilite}</div>
                            <div class="avis-commentaire">${avis.commentaire}</div>
                            <div class="avis-notes">
                                ${buildNoteBar("Qualité cours", avis.qualite_cours)}
                                ${buildNoteBar("Logement", avis.logement)}
                                ${buildNoteBar("Climat", avis.climat)}
                                ${buildNoteBar("Vie locale", avis.vie_locale)}
                                ${buildNoteBar("Accessibilité", avis.accessibilite)}
                            </div>
                            <div class="avis-footer">
                                <span class="avis-likes ${liked ? 'liked' : ''}" data-id="${avis.id_avis}" onclick="toggleLikeAvis(this)">
                                    <svg height="18" width="18" viewBox="0 0 20 20" fill="currentColor" style="vertical-align:middle">
                                        <path d="M10.001 4.529c2.349-4.101 12.036-2.41 9.979 3.396-1.02 2.674-6.919 8.115-9.272 10.034-.381.304-.927.304-1.308 0C6.94 16.04 1.044 10.599.021 7.925c-2.055-5.806 7.629-7.497 9.98-3.396z"></path>
                                    </svg>
                                    <span class="nb-likes">${nbLikes}</span>
                                </span>
                                <button class="avis-signaler" onclick="signalerAvis(${avis.id_avis})">Signaler</button>
                            </div>
                        </li>
                    `;
                });
            } catch (err) {
                document.getElementById("avis-list").innerHTML = "<li>Erreur lors du chargement des avis.</li>";
            }
        }

        afficherTousLesAvis();
    </script>
</body>
</html>
